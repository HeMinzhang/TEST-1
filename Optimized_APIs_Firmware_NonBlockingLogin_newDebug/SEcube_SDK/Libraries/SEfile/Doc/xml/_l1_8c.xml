<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.5">
  <compounddef id="_l1_8c" kind="file">
    <compoundname>L1.c</compoundname>
    <includes refid="_l1_8h" local="yes">L1.h</includes>
    <includes refid="sha256_8h" local="yes">sha256.h</includes>
    <includes refid="aes256_8h" local="yes">aes256.h</includes>
    <incdepgraph>
      <node id="78">
        <label>stdbool.h</label>
      </node>
      <node id="74">
        <label>se3c0def.h</label>
        <link refid="se3c0def_8h_source"/>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
      </node>
      <node id="83">
        <label>se3comm.h</label>
        <link refid="se3comm_8h_source"/>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
      </node>
      <node id="73">
        <label>se3_common.h</label>
        <link refid="se3__common_8h_source"/>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
      </node>
      <node id="81">
        <label>sha256.h</label>
        <link refid="sha256_8h_source"/>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
      </node>
      <node id="76">
        <label>stdint.h</label>
      </node>
      <node id="75">
        <label>stdlib.h</label>
      </node>
      <node id="84">
        <label>Windows.h</label>
      </node>
      <node id="87">
        <label>se3c1def.h</label>
        <link refid="se3c1def_8h"/>
        <childnode refid="74" relation="include">
        </childnode>
      </node>
      <node id="82">
        <label>pbkdf2.h</label>
        <link refid="pbkdf2_8h_source"/>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
      </node>
      <node id="77">
        <label>stddef.h</label>
      </node>
      <node id="70">
        <label>/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c</label>
        <link refid="L1.c"/>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
      </node>
      <node id="71">
        <label>L1.h</label>
        <link refid="_l1_8h_source"/>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
      </node>
      <node id="80">
        <label>string.h</label>
      </node>
      <node id="72">
        <label>L0.h</label>
        <link refid="_l0_8h_source"/>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
      </node>
      <node id="85">
        <label>time.h</label>
      </node>
      <node id="86">
        <label>crc16.h</label>
        <link refid="crc16_8h_source"/>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
      </node>
      <node id="79">
        <label>aes256.h</label>
        <link refid="aes256_8h_source"/>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
      </node>
    </incdepgraph>
      <sectiondef kind="enum">
      <memberdef kind="enum" id="_l1_8c_1afc46ed8f537d3e702d0d4c1145e1fc93" prot="public" static="no">
        <name>L1_AES_CTR_mode</name>
        <enumvalue id="_l1_8c_1afc46ed8f537d3e702d0d4c1145e1fc93acaf4a0a1b6bec48dbcd3ae9e7d5acf05" prot="public">
          <name>L1_AES_CTR_ENCRYPT</name>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="_l1_8c_1afc46ed8f537d3e702d0d4c1145e1fc93afbd3f3c1ebeb0bf6b028388f9d1aff30" prot="public">
          <name>L1_AES_CTR_DECRYPT</name>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="5" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="5" bodyend="8"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="func">
      <memberdef kind="function" id="_l1_8c_1a17552b4c1cfd589790bd63f32d3c16ea" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>static uint16_t L1_TXRX</definition>
        <argsstring>(se3_session *s, uint16_t cmd, uint16_t cmd_flags, uint16_t req_len, uint16_t *resp_len)</argsstring>
        <name>L1_TXRX</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>cmd</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>cmd_flags</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>req_len</declname>
        </param>
        <param>
          <type>uint16_t *</type>
          <declname>resp_len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="10" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="10" bodyend="88"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1aa447e81c8d1260be5d81a171cf8b8994" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void se3_session_init</definition>
        <argsstring>(se3_session *s, se3_device *dev)</argsstring>
        <name>se3_session_init</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type><ref refid="structse3__device__" kindref="compound">se3_device</ref> *</type>
          <declname>dev</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="90" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="90" bodyend="96"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a93504249c7bab5446e5775829141e1c4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_login</definition>
        <argsstring>(se3_session *s, se3_device *dev, const uint8_t *pin, uint16_t access)</argsstring>
        <name>L1_login</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type><ref refid="structse3__device__" kindref="compound">se3_device</ref> *</type>
          <declname>dev</declname>
        </param>
        <param>
          <type>const uint8_t *</type>
          <declname>pin</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>access</declname>
        </param>
        <briefdescription>
<para>This function is used to let a user/admin login on the device. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="out">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to an already allocated se3_session object where to store current logged in session </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">dev</parametername>
</parameternamelist>
<parameterdescription>
<para>Device you want to login to </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">pin</parametername>
</parameternamelist>
<parameterdescription>
<para>Password to login </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">access</parametername>
</parameternamelist>
<parameterdescription>
<para>see <ref refid="group___access_login" kindref="compound">AccessLogin</ref> </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref></para></simplesect>
Before issueing any command to the device, you need to login. Some operations are allowed only to the admin user. After a flash erase, the admin pin and the user pin are both a sequence of 32 0s, please use L1_set_admin_PIN or L1_set_user_PIN to change them. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="98" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="98" bodyend="170"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a56139e0c341bea51092338a52b598508" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_logout</definition>
        <argsstring>(se3_session *s)</argsstring>
        <name>L1_logout</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
<para>This function is used to logout from the device. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Current session you want to end </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref></para></simplesect>
After issueing this function, you will be forbidden to perform any command on the device. This can also be used to free the allocated resources, such as cryptographic sessions, with just one call. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="174" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="174" bodyend="187"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a1b0bf69aa93639a22bceccac81193e3f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>uint32_t L1_config</definition>
        <argsstring>(se3_session *s, uint16_t type, uint16_t op, uint8_t *value)</argsstring>
        <name>L1_config</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>type</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>op</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>value</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="190" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="190" bodyend="221"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1ad53de0ebefe5373659c119c8113b3657" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_set_admin_PIN</definition>
        <argsstring>(se3_session *s, uint8_t *pin)</argsstring>
        <name>L1_set_admin_PIN</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>pin</declname>
        </param>
        <briefdescription>
<para>This function is used to change the current admin pin. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in as admin to issue this command </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">pin</parametername>
</parameternamelist>
<parameterdescription>
<para>New pin to be set </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="224" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="224" bodyend="230"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1ae84071f8782d369bc1b01859d9bcea2e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_set_user_PIN</definition>
        <argsstring>(se3_session *s, uint8_t *pin)</argsstring>
        <name>L1_set_user_PIN</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>pin</declname>
        </param>
        <briefdescription>
<para>This function is used to change the current user pin. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in as admin to issue this command </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">pin</parametername>
</parameternamelist>
<parameterdescription>
<para>New pin to be set </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="233" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="233" bodyend="239"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a944f523188210030c46310bb4f9c07a4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_key_edit</definition>
        <argsstring>(se3_session *s, uint16_t op, se3_key *k)</argsstring>
        <name>L1_key_edit</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>op</declname>
        </param>
        <param>
          <type><ref refid="structse3__key__" kindref="compound">se3_key</ref> *</type>
          <declname>k</declname>
        </param>
        <briefdescription>
<para>This function is used to edit the keys data on the device. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">op</parametername>
</parameternamelist>
<parameterdescription>
<para>see <ref refid="group___key_op_edit" kindref="compound">KeyOpEdit</ref> </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">k</parametername>
</parameternamelist>
<parameterdescription>
<para>Key value you want to add/update/delete </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="242" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="242" bodyend="266"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1ad9e793b818a2e88a826281fd52156ae7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t key_list</definition>
        <argsstring>(se3_session *s, uint16_t skip, uint16_t max_keys, se3_key *key_array, uint16_t *count)</argsstring>
        <name>key_list</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>skip</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>max_keys</declname>
        </param>
        <param>
          <type><ref refid="structse3__key__" kindref="compound">se3_key</ref> *</type>
          <declname>key_array</declname>
        </param>
        <param>
          <type>uint16_t *</type>
          <declname>count</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="268" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="268" bodyend="306"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1af490fb52610e090f43b931968a5756bf" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_key_list</definition>
        <argsstring>(se3_session *s, uint16_t skip, uint16_t max_keys, se3_key *key_array, uint16_t *count)</argsstring>
        <name>L1_key_list</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>skip</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>max_keys</declname>
        </param>
        <param>
          <type><ref refid="structse3__key__" kindref="compound">se3_key</ref> *</type>
          <declname>key_array</declname>
        </param>
        <param>
          <type>uint16_t *</type>
          <declname>count</declname>
        </param>
        <briefdescription>
<para>This function is used get the list of the already of the already available keys on the device. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">skip</parametername>
</parameternamelist>
<parameterdescription>
<para>How many keys you want to skip from the beginning of the list </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">max_keys</parametername>
</parameternamelist>
<parameterdescription>
<para>How many keys you want to retrieve from the device </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">key_array</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to the already allocated array where to store the keys </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">count</parametername>
</parameternamelist>
<parameterdescription>
<para>Effective number of retrieved keys </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="308" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="308" bodyend="318"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a3fb7a8969bf38ea35627226eb56887aa" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool L1_find_key</definition>
        <argsstring>(se3_session *s, uint32_t key_id)</argsstring>
        <name>L1_find_key</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>key_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="320" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="320" bodyend="334"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1aa8dde528e912915caf05aa0b9f322afa" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_crypto_init</definition>
        <argsstring>(se3_session *s, uint16_t algorithm, uint16_t mode, uint32_t key_id, uint32_t *sess_id)</argsstring>
        <name>L1_crypto_init</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>algorithm</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>mode</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>key_id</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>sess_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="338" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="338" bodyend="359"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a52e3abef5c0b45895419819a84584aef" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_crypto_update</definition>
        <argsstring>(se3_session *s, uint32_t sess_id, uint16_t flags, uint16_t data1_len, uint8_t *data1, uint16_t data2_len, uint8_t *data2, uint16_t *dataout_len, uint8_t *data_out)</argsstring>
        <name>L1_crypto_update</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>sess_id</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>flags</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>data1_len</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>data1</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>data2_len</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>data2</declname>
        </param>
        <param>
          <type>uint16_t *</type>
          <declname>dataout_len</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>data_out</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="365" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="365" bodyend="423"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a9305776deffb86003c13d34e1663b38d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_get_algorithms</definition>
        <argsstring>(se3_session *s, uint16_t skip, uint16_t max_algorithms, se3_algo *algorithms_array, uint16_t *count)</argsstring>
        <name>L1_get_algorithms</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>skip</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>max_algorithms</declname>
        </param>
        <param>
          <type><ref refid="structse3__algo__" kindref="compound">se3_algo</ref> *</type>
          <declname>algorithms_array</declname>
        </param>
        <param>
          <type>uint16_t *</type>
          <declname>count</declname>
        </param>
        <briefdescription>
<para>This function is used to retrieve a list from the device of available algorithms. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">skip</parametername>
</parameternamelist>
<parameterdescription>
<para>How many algorithms you want to skip from the beginning of the device list </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">max_algorithms</parametername>
</parameternamelist>
<parameterdescription>
<para>How many algorithms you want to retrieve from the device </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">algorithms_array</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to the already allocated array where to store the algorithms </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">count</parametername>
</parameternamelist>
<parameterdescription>
<para>Effective number of retrieved keys </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="426" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="426" bodyend="466"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1ade253360037f15a7cd51641baf12b392" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_crypto_set_time</definition>
        <argsstring>(se3_session *s, uint32_t devtime)</argsstring>
        <name>L1_crypto_set_time</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>devtime</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="480" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="480" bodyend="490"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a9b18eb68bc75fbe22a42d8e8dd859fc2" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_encrypt</definition>
        <argsstring>(se3_session *s, uint16_t algorithm, uint16_t mode, uint32_t key_id, size_t datain_len, int8_t *data_in, size_t *dataout_len, uint8_t *data_out)</argsstring>
        <name>L1_encrypt</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>algorithm</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>mode</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>key_id</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>datain_len</declname>
        </param>
        <param>
          <type>int8_t *</type>
          <declname>data_in</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>dataout_len</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>data_out</declname>
        </param>
        <briefdescription>
<para>This function is used to encrypt a buffer of data given the algorithm, the encryption mode, the buffer size, and where to store the encrypted data. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">algorithm</parametername>
</parameternamelist>
<parameterdescription>
<para>Which algorithm to use, see <ref refid="group___algorithm_avail" kindref="compound">AlgorithmAvail</ref> </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">mode</parametername>
</parameternamelist>
<parameterdescription>
<para>This parameter strictly depends on the which algorithm is chosen </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">key_id</parametername>
</parameternamelist>
<parameterdescription>
<para>Which key ID to use for encryption </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">datain_len</parametername>
</parameternamelist>
<parameterdescription>
<para>How long is the buffer you want to encrypt </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">data_in</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to the buffer </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">dataout_len</parametername>
</parameternamelist>
<parameterdescription>
<para>How many data were actually encrypted </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">data_out</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a pre-allocated buffer where to store the cipher text </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="493" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="493" bodyend="537"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1a86fb9f1580f1c96bf8db75d050517a0a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_decrypt</definition>
        <argsstring>(se3_session *s, uint16_t algorithm, uint16_t mode, uint32_t key_id, size_t datain_len, int8_t *data_in, size_t *dataout_len, uint8_t *data_out)</argsstring>
        <name>L1_decrypt</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>algorithm</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>mode</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>key_id</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>datain_len</declname>
        </param>
        <param>
          <type>int8_t *</type>
          <declname>data_in</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>dataout_len</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>data_out</declname>
        </param>
        <briefdescription>
<para>This function is used to decrypt a buffer of data given the algorithm, the decryption mode, the buffer size, and where to store the decrypted data. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">algorithm</parametername>
</parameternamelist>
<parameterdescription>
<para>Which algorithm to use, see <ref refid="group___algorithm_avail" kindref="compound">AlgorithmAvail</ref> </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">mode</parametername>
</parameternamelist>
<parameterdescription>
<para>This parameter strictly depends on the which algorithm is chosen </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">key_id</parametername>
</parameternamelist>
<parameterdescription>
<para>Which key ID to use for decryption </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">datain_len</parametername>
</parameternamelist>
<parameterdescription>
<para>How long is the buffer you want to decrypt </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">data_in</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to the buffer </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">dataout_len</parametername>
</parameternamelist>
<parameterdescription>
<para>How many data were actually decrypted </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">data_out</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a pre-allocated buffer where to store the clear text </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="539" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="539" bodyend="542"/>
      </memberdef>
      <memberdef kind="function" id="_l1_8c_1af0b86eb7c3525996587063f924e0acce" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>uint16_t L1_digest</definition>
        <argsstring>(se3_session *s, uint16_t algorithm, size_t datain_len, int8_t *data_in, size_t *dataout_len, uint8_t *data_out)</argsstring>
        <name>L1_digest</name>
        <param>
          <type><ref refid="structse3__session__" kindref="compound">se3_session</ref> *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>algorithm</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>datain_len</declname>
        </param>
        <param>
          <type>int8_t *</type>
          <declname>data_in</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>dataout_len</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>data_out</declname>
        </param>
        <briefdescription>
<para>This function is used to sign a buffer of data given the algorithm, the amount of data to sign and where to store them. </para>        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to current se3_session, you must be logged in </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">algorithm</parametername>
</parameternamelist>
<parameterdescription>
<para>Which algorithm to use, see <ref refid="group___algorithm_avail" kindref="compound">AlgorithmAvail</ref> </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">datain_len</parametername>
</parameternamelist>
<parameterdescription>
<para>How long is the buffer you want to sign </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">data_in</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to the buffer </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">dataout_len</parametername>
</parameternamelist>
<parameterdescription>
<para>How many data were actually signed (can be NULL) </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">data_out</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to a pre-allocated buffer where to store the digest </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>It returns SE3_OK on success, otherwise see <ref refid="se3c1def_8h" kindref="compound">se3c1def.h</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" line="544" column="1" bodyfile="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c" bodystart="544" bodyend="581"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="preprocessor">#include<sp/>&quot;L1.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;sha256.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;aes256.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">enum</highlight><highlight class="normal"><sp/>L1_AES_CTR_mode{</highlight></codeline>
<codeline lineno="6"><highlight class="normal"><sp/><sp/><sp/><sp/>L1_AES_CTR_ENCRYPT,</highlight></codeline>
<codeline lineno="7"><highlight class="normal"><sp/><sp/><sp/><sp/>L1_AES_CTR_DECRYPT</highlight></codeline>
<codeline lineno="8"><highlight class="normal">};</highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint16_t<sp/>L1_TXRX(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>cmd,<sp/>uint16_t<sp/>cmd_flags,<sp/>uint16_t<sp/>req_len,<sp/>uint16_t*<sp/>resp_len)</highlight></codeline>
<codeline lineno="11"><highlight class="normal">{</highlight></codeline>
<codeline lineno="12"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>result;</highlight></codeline>
<codeline lineno="13"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>u16tmp<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="14"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>req_len_padded,<sp/>req0_len;</highlight></codeline>
<codeline lineno="15"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp0_len<sp/>=<sp/>0,<sp/>resp_status<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="16"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>req_iv<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_REQ1_OFFSET_IV,</highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*req_auth<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_REQ1_OFFSET_AUTH;</highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>resp_iv<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_IV,</highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*resp_auth<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_AUTH;</highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s-&gt;logged_in)<sp/>{</highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(s-&gt;buf<sp/>+<sp/>SE3_REQ1_OFFSET_TOKEN,<sp/>s-&gt;token,<sp/>SE3_L1_TOKEN_SIZE);</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(s-&gt;buf<sp/>+<sp/>SE3_REQ1_OFFSET_TOKEN,<sp/>0,<sp/>SE3_L1_TOKEN_SIZE);</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(s-&gt;buf,<sp/>SE3_REQ1_OFFSET_CMD,<sp/>cmd);</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(s-&gt;buf,<sp/>SE3_REQ1_OFFSET_LEN,<sp/>req_len);</highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/>req_len_padded<sp/>=<sp/>req_len;</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(req_len_padded<sp/>%<sp/>SE3_L1_CRYPTOBLOCK_SIZE<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(session_data<sp/>+<sp/>req_len_padded,<sp/>0,<sp/>(SE3_L1_CRYPTOBLOCK_SIZE<sp/>-<sp/>(req_len_padded<sp/>%<sp/>SE3_L1_CRYPTOBLOCK_SIZE)));</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>req_len_padded<sp/>+=<sp/>(SE3_L1_CRYPTOBLOCK_SIZE<sp/>-<sp/>(req_len_padded<sp/>%<sp/>SE3_L1_CRYPTOBLOCK_SIZE));</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/>req0_len<sp/>=<sp/>SE3_REQ1_OFFSET_DATA<sp/>+<sp/>req_len_padded;</highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>encrypt</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(s-&gt;cryptoctx_initialized))<sp/>{</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>se3_payload_cryptoinit(&amp;(s-&gt;cryptoctx),<sp/>s-&gt;key);</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>s-&gt;cryptoctx_initialized<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cmd_flags<sp/>&amp;<sp/>SE3_CMDFLAG_ENCRYPT)<sp/>{</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>se3c_rand(SE3_L1_CRYPTOBLOCK_SIZE,<sp/>req_iv);</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(req_iv,<sp/>0,<sp/>SE3_L1_CRYPTOBLOCK_SIZE);</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/>se3_payload_encrypt(</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;(s-&gt;cryptoctx),<sp/>req_auth,<sp/>req_iv,</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(s-&gt;buf<sp/>+<sp/>SE3_L1_AUTH_SIZE<sp/>+<sp/>SE3_L1_IV_SIZE),<sp/>(req0_len<sp/>-<sp/>SE3_L1_AUTH_SIZE<sp/>-<sp/>SE3_L1_IV_SIZE)<sp/>/<sp/>SE3_L1_CRYPTOBLOCK_SIZE,<sp/>cmd_flags);</highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/>resp0_len<sp/>=<sp/>SE3_COMM_N*SE3_COMM_BLOCK;</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/>result<sp/>=<sp/>L0_TXRX(&amp;(s-&gt;device),<sp/>SE3_CMD0_L1,<sp/>cmd_flags,<sp/>req0_len,<sp/>s-&gt;buf,<sp/>&amp;resp_status,<sp/>&amp;resp0_len,<sp/>s-&gt;buf);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>comm<sp/>error<sp/>status</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>L0<sp/>error<sp/>status<sp/>from<sp/>device</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(resp_status<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>resp_status;</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(resp0_len<sp/>&lt;<sp/>SE3_RESP1_OFFSET_DATA)<sp/>{</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SE3_ERR_COMM;</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="72"><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//decrypt</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!se3_payload_decrypt(</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;(s-&gt;cryptoctx),<sp/>resp_auth,<sp/>resp_iv,</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>s-&gt;buf<sp/>+<sp/>SE3_L1_AUTH_SIZE<sp/>+<sp/>SE3_L1_IV_SIZE,</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(resp0_len<sp/>-<sp/>SE3_L1_AUTH_SIZE<sp/>-<sp/>SE3_L1_IV_SIZE)<sp/>/<sp/>SE3_L1_CRYPTOBLOCK_SIZE,<sp/>cmd_flags))</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_TRACE((</highlight><highlight class="stringliteral">&quot;[L0d_cmd1]<sp/>AUTH<sp/>failed\n&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SE3_ERR_COMM;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_GET16(s-&gt;buf,<sp/>SE3_RESP1_OFFSET_LEN,<sp/>u16tmp);</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/>*resp_len<sp/>=<sp/>u16tmp;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_GET16(s-&gt;buf,<sp/>SE3_RESP1_OFFSET_STATUS,<sp/>u16tmp);</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>L1<sp/>status</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>u16tmp;</highlight></codeline>
<codeline lineno="88"><highlight class="normal">}</highlight></codeline>
<codeline lineno="89"><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>se3_session_init(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/><ref refid="structse3__device__" kindref="compound">se3_device</ref>*<sp/>dev)<sp/>{</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/>memset(s,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structse3__session__" kindref="compound">se3_session</ref>));</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/>s-&gt;logged_in<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(&amp;(s-&gt;device),<sp/>dev,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structse3__device__" kindref="compound">se3_device</ref>));</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(s-&gt;key,<sp/>se3_magic,<sp/>SE3_L1_KEY_SIZE);</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/>s-&gt;cryptoctx_initialized<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="96"><highlight class="normal">}</highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal">uint16_t<sp/>L1_login(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/><ref refid="structse3__device__" kindref="compound">se3_device</ref>*<sp/>dev,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t*<sp/>pin,<sp/>uint16_t<sp/>access)<sp/>{</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>cc1[SE3_L1_CHALLENGE_SIZE],<sp/>cc2[SE3_L1_CHALLENGE_SIZE],<sp/>sc[SE3_L1_CHALLENGE_SIZE],<sp/>sresp_expected[SE3_L1_CHALLENGE_SIZE];</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>req_len<sp/>=<sp/>0,<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error;</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>only<sp/>for<sp/>login</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/>se3_session_init(s,<sp/>dev);</highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Prepare<sp/>data<sp/>to<sp/>be<sp/>sent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//memset(s-&gt;buf,<sp/>0,<sp/>SE3_COMM_N<sp/>*<sp/>SE3_COMM_BLOCK);<sp/><sp/><sp/>//<sp/>Clear<sp/>buffer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/>se3c_rand(SE3_L1_CHALLENGE_SIZE,<sp/>cc1);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Generates<sp/>2<sp/>randoms<sp/>for<sp/>Challenge</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/>se3c_rand(SE3_L1_CHALLENGE_SIZE,<sp/>cc2);</highlight></codeline>
<codeline lineno="110"><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_CHALLENGE_REQ_OFF_CC1,<sp/>cc1,<sp/>SE3_L1_CHALLENGE_SIZE);</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_CHALLENGE_REQ_OFF_CC2,<sp/>cc2,<sp/>SE3_L1_CHALLENGE_SIZE);</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_CHALLENGE_REQ_OFF_ACCESS,<sp/>access);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/>req_len<sp/>=<sp/>SE3_CMD1_CHALLENGE_REQ_OFF_ACCESS<sp/>+<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(uint16_t);</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>Challenge</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_CHALLENGE,<sp/>0,<sp/>req_len,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO<sp/>check<sp/>response<sp/>length</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"></highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>Server<sp/>Challenge<sp/>sc</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(sc,<sp/>session_data<sp/>+<sp/>SE3_CMD1_CHALLENGE_RESP_OFF_SC,<sp/>SE3_L1_CHALLENGE_SIZE);</highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>server<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sresp<sp/>=<sp/>PBKDF2(HMACSHA256,<sp/>pin,<sp/>cc1,<sp/>SE3_L1_CHALLENGE_ITERATIONS,<sp/>SE3_CHALLENGE_SIZE)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/>PBKDF2HmacSha256(pin,<sp/>SE3_L1_PIN_SIZE,<sp/>cc1,</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_L1_CHALLENGE_SIZE,<sp/>SE3_L1_CHALLENGE_ITERATIONS,<sp/>sresp_expected,<sp/>SE3_L1_CHALLENGE_SIZE);</highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(sresp_expected,<sp/>session_data<sp/>+<sp/>SE3_CMD1_CHALLENGE_RESP_OFF_SRESP,<sp/>SE3_L1_CHALLENGE_SIZE))<sp/>{</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="se3c1def_8h_1abed82baf7f470b522273a3e37c24c600af6bcc762e361bb3a06832370b72c1e6f" kindref="member">SE3_ERR_PIN</ref>;</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//memset(s-&gt;buf,<sp/>0,<sp/>SE3_COMM_N<sp/>*<sp/>SE3_COMM_BLOCK);<sp/><sp/><sp/>//<sp/>Clear<sp/>buffer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Prepare<sp/>session<sp/>key</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>key<sp/>=<sp/>PBKDF2(HMACSHA256,<sp/>pin,<sp/>cc2,<sp/>1,<sp/>SE3_L1_PIN_SIZE)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/>PBKDF2HmacSha256(pin,<sp/>SE3_L1_PIN_SIZE,<sp/>cc2,</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_L1_CHALLENGE_SIZE,<sp/>1,<sp/>s-&gt;key,<sp/>SE3_L1_PIN_SIZE);</highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>s-&gt;logged_in<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>---<sp/>Encryption<sp/>can<sp/>begin<sp/>here<sp/>---</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Prepare<sp/>Challenge<sp/>Response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>cresp<sp/>=<sp/>PBKDF2(HMACSHA256,<sp/>pin,<sp/>sc,<sp/>SE3_L1_CHALLENGE_ITERATIONS,<sp/>SE3_CHALLENGE_SIZE)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/>PBKDF2HmacSha256(pin,<sp/>SE3_L1_PIN_SIZE,<sp/>sc,</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_L1_CHALLENGE_SIZE,<sp/>SE3_L1_CHALLENGE_ITERATIONS,</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session_data<sp/>+<sp/>SE3_CMD1_LOGIN_REQ_OFF_CRESP,<sp/>SE3_L1_CHALLENGE_SIZE);</highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/>req_len<sp/>=<sp/>SE3_L1_CHALLENGE_SIZE;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>Login<sp/>command</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_LOGIN,<sp/>SE3_CMDFLAG_ENCRYPT<sp/>|<sp/>SE3_CMDFLAG_SIGN,<sp/>req_len,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>s-&gt;logged_in<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO<sp/>check<sp/>response<sp/>length</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"></highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>Token</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(s-&gt;token,<sp/>session_data<sp/>+<sp/>SE3_CMD1_LOGIN_RESP_OFF_TOKEN,<sp/>SE3_L1_TOKEN_SIZE);</highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>s-&gt;logged_in<sp/>=<sp/>true;<sp/><sp/>//<sp/>moved<sp/>up</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="170"><highlight class="normal">}</highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal">uint16_t<sp/>L1_logout(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s)<sp/>{</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>data_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s-&gt;logged_in)<sp/>{</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SE3_ERR_STATE;</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_LOGOUT,<sp/>0,<sp/>data_len,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/>s-&gt;logged_in<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="187"><highlight class="normal">}</highlight></codeline>
<codeline lineno="188"><highlight class="normal"></highlight></codeline>
<codeline lineno="189"><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal">uint32_t<sp/>L1_config(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>type,<sp/>uint16_t<sp/>op,<sp/>uint8_t*<sp/>value)<sp/>{</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>config<sp/>:<sp/>(type:ui16,<sp/>op:ui16,<sp/>value[32])<sp/>=&gt;<sp/>(value[32])</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>resp::value<sp/>e&apos;<sp/>vuoto<sp/>(zeri)<sp/>se<sp/>op=SET</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>req::value<sp/>e&apos;<sp/>vuoto<sp/>(zeri)<sp/>se<sp/>op=GET</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>datalen<sp/>=<sp/>0,<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_CONFIG_REQ_OFF_ID,<sp/>type);<sp/><sp/><sp/></highlight><highlight class="comment">//set<sp/>type<sp/><sp/><sp/>//<sp/>per<sp/>SE3_..._ID<sp/>intendi<sp/>se<sp/>USER<sp/>o<sp/>ADMIN<sp/>(cio type?)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_CONFIG_REQ_OFF_OP,<sp/>op);<sp/><sp/><sp/></highlight><highlight class="comment">//set<sp/>op</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(op<sp/>==<sp/>SE3_CONFIG_OP_GET)<sp/>{<sp/><sp/><sp/></highlight><highlight class="comment">//set<sp/>value</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(session_data<sp/>+<sp/>SE3_CMD1_CONFIG_REQ_OFF_VALUE,<sp/>0,<sp/>SE3_RECORD_SIZE);<sp/><sp/><sp/></highlight><highlight class="comment">//write<sp/>value<sp/>(all<sp/>0s)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(op<sp/>==<sp/>SE3_CONFIG_OP_SET)<sp/>{</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_CONFIG_REQ_OFF_VALUE,<sp/>value,<sp/>SE3_RECORD_SIZE);<sp/><sp/><sp/></highlight><highlight class="comment">//write<sp/>value</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="207"><highlight class="normal"></highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/>datalen<sp/>=<sp/>2<sp/>+<sp/>2<sp/>+<sp/>SE3_RECORD_SIZE;<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>type<sp/>+<sp/>op<sp/>+<sp/>value</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_CONFIG,<sp/>0,<sp/>datalen,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="213"><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>in<sp/>session_data<sp/>there<sp/>is<sp/>the<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(op<sp/>==<sp/>SE3_CONFIG_OP_GET)<sp/>{</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(value,<sp/>session_data<sp/>+<sp/>SE3_CMD1_CONFIG_RESP_OFF_VALUE,<sp/>SE3_RECORD_SIZE);</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="218"><highlight class="normal"></highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>return(value);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SE3_OK;</highlight></codeline>
<codeline lineno="221"><highlight class="normal">}</highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal">uint16_t<sp/>L1_set_admin_PIN(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint8_t*<sp/>pin)<sp/>{</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>TODO:<sp/>Add<sp/>flag<sp/>at<sp/>se3_session<sp/>for<sp/>type<sp/>of<sp/>user</highlight></codeline>
<codeline lineno="226"><highlight class="comment"><sp/><sp/><sp/><sp/>and<sp/>provide<sp/>here<sp/>checks<sp/>to<sp/>avoid<sp/>to<sp/>set<sp/>PIN<sp/>if<sp/>not<sp/>logged</highlight></codeline>
<codeline lineno="227"><highlight class="comment"><sp/><sp/><sp/><sp/>just<sp/>let<sp/>the<sp/>board<sp/>fail<sp/><sp/>^</highlight></codeline>
<codeline lineno="228"><highlight class="comment"><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>L1_config(s,<sp/>SE3_RECORD_TYPE_ADMINPIN,<sp/>SE3_CONFIG_OP_SET,<sp/>pin);</highlight></codeline>
<codeline lineno="230"><highlight class="normal">}</highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal">uint16_t<sp/>L1_set_user_PIN(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint8_t*<sp/>pin)<sp/>{</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>TODO:<sp/>Add<sp/>flag<sp/>at<sp/>se3_session<sp/>for<sp/>type<sp/>of<sp/>user</highlight></codeline>
<codeline lineno="235"><highlight class="comment"><sp/><sp/><sp/><sp/>and<sp/>provide<sp/>here<sp/>checks<sp/>to<sp/>avoid<sp/>to<sp/>set<sp/>PIN<sp/>if<sp/>not<sp/>logged</highlight></codeline>
<codeline lineno="236"><highlight class="comment"><sp/><sp/><sp/><sp/>just<sp/>let<sp/>the<sp/>board<sp/>fail<sp/><sp/>^</highlight></codeline>
<codeline lineno="237"><highlight class="comment"><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>L1_config(s,<sp/>SE3_RECORD_TYPE_USERPIN,<sp/>SE3_CONFIG_OP_SET,<sp/>pin);</highlight></codeline>
<codeline lineno="239"><highlight class="normal">}</highlight></codeline>
<codeline lineno="240"><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal">uint16_t<sp/>L1_key_edit(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>op,<sp/><ref refid="structse3__key__" kindref="compound">se3_key</ref>*<sp/>k)<sp/>{</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>data_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(k<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_ERR_PARAMS);</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_OP,<sp/>op);</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_ID,<sp/>k-&gt;id);</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_VALIDITY,<sp/>k-&gt;validity);</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_DATA_LEN,<sp/>k-&gt;data_size);</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_NAME_LEN,<sp/>k-&gt;name_size);</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_DATA_AND_NAME,<sp/>k-&gt;data,<sp/>k-&gt;data_size);</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_KEY_EDIT_REQ_OFF_DATA_AND_NAME<sp/>+<sp/>k-&gt;data_size,<sp/>k-&gt;name,<sp/>k-&gt;name_size);</highlight></codeline>
<codeline lineno="258"><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/>data_len<sp/>=<sp/>2<sp/>+<sp/>4<sp/>+<sp/>4<sp/>+<sp/>2<sp/>+<sp/>2<sp/>+<sp/>k-&gt;data_size<sp/>+<sp/>k-&gt;name_size;<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>op<sp/>+<sp/>id<sp/>+<sp/>validity<sp/>+<sp/>data_size<sp/>+<sp/>name_size<sp/>+<sp/>data<sp/>+<sp/>name</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_KEY_EDIT,<sp/>SE3_CMDFLAG_ENCRYPT<sp/>|<sp/>SE3_CMDFLAG_SIGN,<sp/>data_len,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="266"><highlight class="normal">}</highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal">uint16_t<sp/>key_list(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>skip,<sp/>uint16_t<sp/>max_keys,<sp/><ref refid="structse3__key__" kindref="compound">se3_key</ref>*<sp/>key_array,<sp/>uint16_t*<sp/>count)<sp/>{</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>n_keys<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>offset_key<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>parameters</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(max_keys<sp/>&lt;=<sp/>0<sp/>||<sp/>skip<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_ERR_PARAMS);</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="279"><highlight class="normal"></highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_KEY_LIST_REQ_OFF_SKIP,<sp/>skip);</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_KEY_LIST_REQ_OFF_NMAX,<sp/>max_keys);</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_KEY_LIST,<sp/>0,<sp/>SE3_CMD1_KEY_LIST_REQ_SIZE,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_GET16(session_data,<sp/>SE3_CMD1_KEY_LIST_RESP_OFF_COUNT,<sp/>n_keys);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>number<sp/>of<sp/>keys<sp/>returned</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//if(n_keys<sp/>==<sp/>0)<sp/>return(???)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/>offset_key<sp/>=<sp/>2;</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n_keys;<sp/>i++)<sp/>{<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fills<sp/>with<sp/>key<sp/>received</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET32(session_data,<sp/>offset_key<sp/>+<sp/>SE3_CMD1_KEY_LIST_KEYINFO_OFF_ID,<sp/>key_array[i].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET32(session_data,<sp/>offset_key<sp/>+<sp/>SE3_CMD1_KEY_LIST_KEYINFO_OFF_VALIDITY,<sp/>key_array[i].validity);</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET16(session_data,<sp/>offset_key<sp/>+<sp/>SE3_CMD1_KEY_LIST_KEYINFO_OFF_DATA_LEN,<sp/>key_array[i].data_size);</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET16(session_data,<sp/>offset_key<sp/>+<sp/>SE3_CMD1_KEY_LIST_KEYINFO_OFF_NAME_LEN,<sp/>key_array[i].name_size);</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(key_array[i].name,<sp/>session_data<sp/>+<sp/>offset_key<sp/>+<sp/>SE3_CMD1_KEY_LIST_KEYINFO_OFF_NAME,<sp/>key_array[i].name_size);</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offset_key<sp/>+=<sp/>4<sp/>+<sp/>4<sp/>+<sp/>2<sp/>+<sp/>2<sp/>+<sp/>key_array[i].name_size;<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>id<sp/>+<sp/>validity<sp/>+<sp/>data_size<sp/>+<sp/>name_size<sp/>+<sp/>name[name_size]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="302"><highlight class="normal"></highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/>*count<sp/>=<sp/>n_keys;</highlight></codeline>
<codeline lineno="304"><highlight class="normal"></highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="306"><highlight class="normal">}</highlight></codeline>
<codeline lineno="307"><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal">uint16_t<sp/>L1_key_list(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>skip,<sp/>uint16_t<sp/>max_keys,<sp/><ref refid="structse3__key__" kindref="compound">se3_key</ref>*<sp/>key_array,<sp/>uint16_t*<sp/>count)<sp/>{</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>return_value<sp/>=<sp/>0,<sp/>xcount<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>!=<sp/>max_keys<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(return_value<sp/>=<sp/>key_list(s,<sp/>i<sp/>+<sp/>skip,<sp/>max_keys<sp/>-<sp/>i,<sp/>&amp;(key_array[i]),<sp/>&amp;xcount))<sp/>==<sp/>0<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>xcount&gt;0){</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>i<sp/>+=<sp/>xcount;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/>*count<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_value;</highlight></codeline>
<codeline lineno="318"><highlight class="normal">}</highlight></codeline>
<codeline lineno="319"><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>L1_find_key(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint32_t<sp/>key_id){</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">enum</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FIND_KEY_NUM<sp/>=<sp/>50</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structse3__key__" kindref="compound">se3_key</ref><sp/>key_array[FIND_KEY_NUM];</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>ret<sp/>=<sp/>SE3_OK,<sp/>count<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0,<sp/>j<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>((ret<sp/>=<sp/>L1_key_list(s,<sp/>i,<sp/>i<sp/>+<sp/>FIND_KEY_NUM,<sp/>key_array,<sp/>&amp;count))<sp/>==<sp/>SE3_OK<sp/>&amp;&amp;<sp/>count&gt;0){</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(j<sp/>=<sp/>0;<sp/>j&lt;count;<sp/>j++){</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(key_array[j].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>==<sp/>key_id<sp/>&amp;&amp;<sp/>key_array[j].validity&gt;time(0))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>i<sp/>+=<sp/>count;</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="334"><highlight class="normal">}</highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"></highlight><highlight class="comment">//L1_crypto_init:<sp/>(algo:ui16,<sp/>mode<sp/>:<sp/>ui16,<sp/>key_id<sp/>:<sp/>ui32)<sp/>=<sp/>&gt;<sp/>(sid:ui32)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="338"><highlight class="normal">uint16_t<sp/>L1_crypto_init(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>algorithm,<sp/>uint16_t<sp/>mode,<sp/>uint32_t<sp/>key_id,<sp/>uint32_t*<sp/>sess_id)<sp/>{</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>u32tmp<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Prepare<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_CRYPTO_INIT_REQ_OFF_ALGO,<sp/>algorithm);</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_CRYPTO_INIT_REQ_OFF_MODE,<sp/>mode);</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_CRYPTO_INIT_REQ_OFF_KEY_ID,<sp/>key_id);</highlight></codeline>
<codeline lineno="347"><highlight class="normal"></highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_CRYPTO_INIT,<sp/>0,<sp/>SE3_CMD1_CRYPTO_INIT_REQ_SIZE,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="353"><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_GET32(session_data,<sp/>SE3_CMD1_CRYPTO_INIT_RESP_OFF_SID,<sp/>u32tmp);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>extract<sp/>Session<sp/>ID</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/>*sess_id<sp/>=<sp/>u32tmp;</highlight></codeline>
<codeline lineno="357"><highlight class="normal"></highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="359"><highlight class="normal">}</highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight></codeline>
<codeline lineno="361"><highlight class="normal"></highlight></codeline>
<codeline lineno="362"><highlight class="normal"></highlight><highlight class="comment">//<sp/>L1_crypto_update<sp/>:<sp/>(sid:ui32,<sp/>flags<sp/>:<sp/>ui16,<sp/>datain1<sp/>-<sp/>len<sp/>:<sp/>ui16,<sp/>datain2<sp/>-<sp/>len<sp/>:<sp/>ui16,<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="363"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pad<sp/>-<sp/>to<sp/>-<sp/>16[6],<sp/>*datain1[datain1<sp/>-<sp/>len],<sp/>pad<sp/>-<sp/>to<sp/>-<sp/>16[...],<sp/>datain2[datain2<sp/>-<sp/>len])</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="364"><highlight class="normal"></highlight><highlight class="comment">//<sp/>=<sp/>&gt;<sp/>(dataout<sp/>-<sp/>len,<sp/>pad<sp/>-<sp/>to<sp/>-<sp/>16[14],<sp/>dataout[dataout<sp/>-<sp/>len]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="365"><highlight class="normal">uint16_t<sp/>L1_crypto_update(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>sess_id,</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>flags,</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>data1_len,</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>data1,</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>data2_len,</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>data2,</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t*<sp/>dataout_len,</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>data_out)<sp/>{</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>data_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>data1_len_pad16<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>u16tmp;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Prepare<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//memset(session_data,<sp/>0,<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_DATA);<sp/><sp/><sp/>//<sp/>Clear<sp/>buffer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_SID,<sp/>sess_id);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Session<sp/>ID</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET16(session_data,<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_FLAGS,<sp/>flags);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Flags</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_DATAIN1_LEN,<sp/>data1_len);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Length<sp/>of<sp/>Data1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_DATAIN2_LEN,<sp/>data2_len);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Length<sp/>of<sp/>Data2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>compute<sp/>offset<sp/>for<sp/>data2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(data1_len<sp/>%<sp/>16<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data1_len_pad16<sp/>=<sp/>data1_len<sp/>+<sp/>(16<sp/>-<sp/>(data1_len<sp/>%<sp/>16));</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>data1_len_pad16<sp/>=<sp/>data1_len;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>whether<sp/>we<sp/>exceed<sp/>buffer<sp/>length</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/>data_len<sp/>=<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_DATA<sp/>+<sp/>data1_len_pad16<sp/>+<sp/>data2_len;</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(data_len<sp/>&gt;<sp/>SE3_REQ1_MAX_DATA)<sp/>{</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SE3_ERR_PARAMS;</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>copy<sp/>data1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(data1_len<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_DATA,<sp/>data1,<sp/>data1_len);</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//copy<sp/>data2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(data2_len<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(session_data<sp/>+<sp/>SE3_CMD1_CRYPTO_UPDATE_REQ_OFF_DATA<sp/>+<sp/>data1_len_pad16,<sp/>data2,<sp/>data2_len);</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="406"><highlight class="normal"></highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="408"><highlight class="normal"></highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_CRYPTO_UPDATE,<sp/>0,<sp/>data_len,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="413"><highlight class="normal"></highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_GET16(session_data,<sp/>SE3_CMD1_CRYPTO_UPDATE_RESP_OFF_DATAOUT_LEN,<sp/>u16tmp);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>extract<sp/>length<sp/>of<sp/>output<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dataout_len<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*dataout_len<sp/>=<sp/>u16tmp;</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(data_out<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(data_out,<sp/>session_data<sp/>+<sp/>SE3_CMD1_CRYPTO_UPDATE_RESP_OFF_DATA,<sp/>u16tmp);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>extract<sp/>output<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"></highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="423"><highlight class="normal">}</highlight></codeline>
<codeline lineno="424"><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"></highlight></codeline>
<codeline lineno="426"><highlight class="normal">uint16_t<sp/>L1_get_algorithms(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>skip,</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>max_algorithms,</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structse3__algo__" kindref="compound">se3_algo</ref>*<sp/>algorithms_array,</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t*<sp/>count)<sp/>{</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>n_algo<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>offset_algo<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>alg_to_skip<sp/>=<sp/>skip<sp/>*<sp/>SE3_CMD1_CRYPTO_ALGOINFO_SIZE;</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="438"><highlight class="normal"></highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>parameters</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(max_algorithms<sp/>&lt;=<sp/>0<sp/>||<sp/>skip<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_ERR_PARAMS);</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="443"><highlight class="normal"></highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_CRYPTO_LIST,<sp/>0,<sp/>SE3_CMD1_CRYPTO_LIST_REQ_SIZE,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="449"><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_GET16(session_data,<sp/>SE3_CMD1_CRYPTO_LIST_RESP_OFF_COUNT,<sp/>n_algo);<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>extract<sp/>number<sp/>of<sp/>algorithms<sp/>returned</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/>offset_algo<sp/>=<sp/>SE3_CMD1_CRYPTO_LIST_RESP_OFF_ALGOINFO<sp/>+<sp/>skip<sp/>*<sp/>SE3_CMD1_CRYPTO_ALGOINFO_SIZE;</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0,<sp/>j<sp/>=<sp/>skip;<sp/>i<sp/>&lt;<sp/>max_algorithms<sp/>&amp;&amp;<sp/>j<sp/>&lt;<sp/>n_algo;<sp/>i++,<sp/>j++)<sp/>{<sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fills<sp/>array<sp/>with<sp/>algorithm(s)<sp/>received</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(algorithms_array[i].name,<sp/>session_data<sp/>+<sp/>offset_algo<sp/>+<sp/>SE3_CMD1_CRYPTO_ALGOINFO_OFF_NAME,<sp/>SE3_CMD1_CRYPTO_ALGOINFO_NAME_SIZE);</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET16(session_data<sp/>+<sp/>offset_algo,<sp/>SE3_CMD1_CRYPTO_ALGOINFO_OFF_TYPE,<sp/>algorithms_array[i].type);</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET16(session_data<sp/>+<sp/>offset_algo,<sp/>SE3_CMD1_CRYPTO_ALGOINFO_OFF_BLOCK_SIZE,<sp/>algorithms_array[i].block_size);</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SE3_GET16(session_data<sp/>+<sp/>offset_algo,<sp/>SE3_CMD1_CRYPTO_ALGOINFO_OFF_KEY_SIZE,<sp/>algorithms_array[i].key_size);</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offset_algo<sp/>+=<sp/>SE3_CMD1_CRYPTO_ALGOINFO_SIZE;</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/>*count<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"></highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_OK);</highlight></codeline>
<codeline lineno="466"><highlight class="normal">}</highlight></codeline>
<codeline lineno="467"><highlight class="normal"></highlight></codeline>
<codeline lineno="468"><highlight class="normal"></highlight></codeline>
<codeline lineno="469"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>USELESS<sp/>FUNCTIONS</highlight></codeline>
<codeline lineno="470"><highlight class="comment">uint16_t<sp/>digest_init(se3_session*<sp/>s,<sp/>uint16_t<sp/>algorithm,<sp/>uint16_t<sp/>mode,<sp/>uint32_t<sp/>key_id,<sp/>uint32_t*<sp/>sess_id){</highlight></codeline>
<codeline lineno="471"><highlight class="comment">return<sp/>L1_crypto_init(s,<sp/>algorithm,<sp/>mode,<sp/>key_id,<sp/>sess_id);</highlight></codeline>
<codeline lineno="472"><highlight class="comment">}</highlight></codeline>
<codeline lineno="473"><highlight class="comment"></highlight></codeline>
<codeline lineno="474"><highlight class="comment"></highlight></codeline>
<codeline lineno="475"><highlight class="comment">uint16_t<sp/>digest_update(se3_session*<sp/>s,<sp/><sp/>uint32_t<sp/>sess_id,<sp/><sp/><sp/>uint16_t<sp/>flags,<sp/>uint16_t<sp/>data1_len,<sp/>uint8_t*<sp/>data1,<sp/>uint16_t*<sp/>dataout_len,<sp/><sp/>uint8_t*<sp/>data_out)<sp/>{</highlight></codeline>
<codeline lineno="476"><highlight class="comment">return<sp/>L1_crypto_update(s,<sp/><sp/>sess_id,<sp/>flags,<sp/>data1_len,<sp/>data1,<sp/>0,<sp/>NULL,<sp/>dataout_len,<sp/>data_out);</highlight></codeline>
<codeline lineno="477"><highlight class="comment">}</highlight></codeline>
<codeline lineno="478"><highlight class="comment">*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="479"><highlight class="normal"></highlight></codeline>
<codeline lineno="480"><highlight class="normal">uint16_t<sp/>L1_crypto_set_time(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint32_t<sp/>devtime){</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>return_value<sp/>=<sp/>0,<sp/>resp_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>current_time<sp/>=<sp/>devtime;</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>session_data<sp/>=<sp/>s-&gt;buf<sp/>+<sp/>SE3_RESP1_OFFSET_DATA;</highlight></codeline>
<codeline lineno="484"><highlight class="normal"></highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/>SE3_SET32(session_data,<sp/>SE3_CMD1_CRYPTO_SET_TIME_REQ_OFF_DEVTIME,<sp/>current_time);</highlight></codeline>
<codeline lineno="486"><highlight class="normal"></highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/>return_value<sp/>=<sp/>L1_TXRX(s,<sp/>SE3_CMD1_CRYPTO_SET_TIME,<sp/>0,<sp/>SE3_CMD1_CRYPTO_SET_TIME_REQ_SIZE,<sp/>&amp;resp_len);</highlight></codeline>
<codeline lineno="488"><highlight class="normal"></highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>return_value;</highlight></codeline>
<codeline lineno="490"><highlight class="normal">}</highlight></codeline>
<codeline lineno="491"><highlight class="normal"></highlight></codeline>
<codeline lineno="492"><highlight class="normal"></highlight></codeline>
<codeline lineno="493"><highlight class="normal">uint16_t<sp/>L1_encrypt(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>algorithm,<sp/>uint16_t<sp/>mode,<sp/>uint32_t<sp/>key_id,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>datain_len,<sp/>int8_t*<sp/>data_in,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">*<sp/>dataout_len,<sp/>uint8_t*<sp/>data_out)<sp/>{</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>sp<sp/>=<sp/>data_in,<sp/>*rp<sp/>=<sp/>data_out;</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>SE3_OK;</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>curr_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>enc_sess_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>curr_chunk<sp/>=<sp/>datain_len<sp/>&lt;<sp/>SE3_CRYPTO_MAX_DATAIN<sp/>?<sp/>datain_len<sp/>:<sp/>SE3_CRYPTO_MAX_DATAIN;</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>direction<sp/>=<sp/>mode<sp/>&amp;<sp/>SE3_DIR_ENCRYPT<sp/>?<sp/>SE3_DIR_ENCRYPT<sp/>:<sp/>SE3_DIR_DECRYPT;</highlight></codeline>
<codeline lineno="500"><highlight class="normal"></highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(datain_len<sp/>&lt;<sp/>0<sp/>||<sp/>data_out<sp/>==<sp/>NULL)</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_ERR_PARAMS);</highlight></codeline>
<codeline lineno="503"><highlight class="normal"></highlight></codeline>
<codeline lineno="504"><highlight class="normal"></highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_crypto_init(s,<sp/>algorithm,<sp/>mode,<sp/>key_id,<sp/>&amp;enc_sess_id);</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="509"><highlight class="normal"></highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dataout_len<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*dataout_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="512"><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((algorithm<sp/>&amp;<sp/><ref refid="group___algorithm_avail_1ggae4d5251432e1a9e6803c0240cc492e18adaed4c5a46ddce535c2c0614e1f88c4f" kindref="member">SE3_ALGO_AES_HMAC</ref>)<sp/>&amp;&amp;<sp/>curr_chunk<sp/>==<sp/>SE3_CRYPTO_MAX_DATAIN){</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>curr_chunk<sp/>-=<sp/>B5_SHA256_DIGEST_SIZE;</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(datain_len<sp/>-<sp/>curr_chunk)</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_crypto_update(s,<sp/>enc_sess_id,<sp/>mode,<sp/>0,<sp/>NULL,<sp/>(uint16_t)curr_chunk,<sp/>sp,<sp/>&amp;curr_len,<sp/>rp);</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_crypto_update(s,<sp/>enc_sess_id,<sp/>SE3_CRYPTO_FLAG_FINIT<sp/>|<sp/>mode,<sp/>0,<sp/>NULL,<sp/>(uint16_t)curr_chunk,<sp/>sp,<sp/>&amp;curr_len,<sp/>rp);</highlight></codeline>
<codeline lineno="521"><highlight class="normal"></highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>datain_len<sp/>-=<sp/>curr_chunk;</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sp<sp/>+=<sp/>curr_chunk;</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rp<sp/>+=<sp/>curr_chunk;</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>curr_chunk<sp/>=<sp/>datain_len<sp/>&lt;<sp/>SE3_CRYPTO_MAX_DATAIN<sp/>?<sp/>datain_len<sp/>:<sp/>SE3_CRYPTO_MAX_DATAIN;</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((algorithm<sp/>&amp;<sp/>SE3_ALGO_AES_HMAC)<sp/>&amp;&amp;<sp/>curr_chunk<sp/>==<sp/>SE3_CRYPTO_MAX_DATAIN){</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>curr_chunk<sp/>-=<sp/>B5_SHA256_DIGEST_SIZE;</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="529"><highlight class="normal"></highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dataout_len<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*dataout_len<sp/>+=<sp/>curr_len;</highlight></codeline>
<codeline lineno="532"><highlight class="normal"></highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(datain_len<sp/>&gt;<sp/>0);</highlight></codeline>
<codeline lineno="534"><highlight class="normal"></highlight></codeline>
<codeline lineno="535"><highlight class="normal"></highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(error);</highlight></codeline>
<codeline lineno="537"><highlight class="normal">}</highlight></codeline>
<codeline lineno="538"><highlight class="normal"></highlight></codeline>
<codeline lineno="539"><highlight class="normal">uint16_t<sp/>L1_decrypt(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>algorithm,<sp/>uint16_t<sp/>mode,<sp/>uint32_t<sp/>key_id,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>datain_len,<sp/>int8_t*<sp/>data_in,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">*<sp/>dataout_len,<sp/>uint8_t*<sp/>data_out)<sp/>{</highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>enc_sess_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>L1_encrypt(s,<sp/>algorithm,<sp/>mode,<sp/>key_id,<sp/>datain_len,<sp/>data_in,<sp/>dataout_len,<sp/>data_out);</highlight></codeline>
<codeline lineno="542"><highlight class="normal">}</highlight></codeline>
<codeline lineno="543"><highlight class="normal"></highlight></codeline>
<codeline lineno="544"><highlight class="normal">uint16_t<sp/>L1_digest(<ref refid="structse3__session__" kindref="compound">se3_session</ref>*<sp/>s,<sp/>uint16_t<sp/>algorithm,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>datain_len,<sp/>int8_t*<sp/>data_in,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">*<sp/>dataout_len,<sp/>uint8_t*<sp/>data_out)<sp/>{</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t*<sp/>sp<sp/>=<sp/>data_in,<sp/>*rp<sp/>=<sp/>data_out;</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>error<sp/>=<sp/>SE3_OK;</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>curr_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>curr_chunk<sp/>=<sp/>datain_len<sp/>&lt;<sp/>SE3_CRYPTO_MAX_DATAIN<sp/>?<sp/>datain_len<sp/>:<sp/>SE3_CRYPTO_MAX_DATAIN;</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>enc_sess_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="550"><highlight class="normal"></highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(datain_len<sp/>&lt;<sp/>0<sp/>||<sp/>data_out<sp/>==<sp/>NULL)</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(SE3_ERR_PARAMS);</highlight></codeline>
<codeline lineno="553"><highlight class="normal"></highlight></codeline>
<codeline lineno="554"><highlight class="normal"></highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_crypto_init(s,<sp/>algorithm,<sp/>0,<sp/>0,<sp/>&amp;enc_sess_id);</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(error<sp/>!=<sp/>SE3_OK)<sp/>{</highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>error;</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="559"><highlight class="normal"></highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dataout_len<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*dataout_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="562"><highlight class="normal"></highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(datain_len<sp/>-<sp/>curr_chunk)</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_crypto_update(s,<sp/>enc_sess_id,<sp/>0,<sp/>(uint16_t)curr_chunk,<sp/>sp,<sp/>0,<sp/>NULL,<sp/>&amp;curr_len,<sp/>rp);</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>error<sp/>=<sp/>L1_crypto_update(s,<sp/>enc_sess_id,<sp/>SE3_CRYPTO_FLAG_FINIT,<sp/>(uint16_t)curr_chunk,<sp/>sp,<sp/>0,<sp/>NULL,<sp/>&amp;curr_len,<sp/>rp);</highlight></codeline>
<codeline lineno="568"><highlight class="normal"></highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>datain_len<sp/>-=<sp/>curr_chunk;</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sp<sp/>+=<sp/>curr_chunk;</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>curr_chunk<sp/>=<sp/>datain_len<sp/>&lt;<sp/>SE3_CRYPTO_MAX_DATAIN<sp/>?<sp/>datain_len<sp/>:<sp/>SE3_CRYPTO_MAX_DATAIN;</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(dataout_len<sp/>!=<sp/>NULL)<sp/></highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*dataout_len<sp/>+=<sp/>curr_len;</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="576"><highlight class="normal"></highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(datain_len<sp/>&gt;<sp/>0);</highlight></codeline>
<codeline lineno="578"><highlight class="normal"></highlight></codeline>
<codeline lineno="579"><highlight class="normal"></highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">(error);</highlight></codeline>
<codeline lineno="581"><highlight class="normal">}</highlight></codeline>
<codeline lineno="582"><highlight class="normal"></highlight></codeline>
    </programlisting>
    <location file="/run/media/scaglia/5B106C33792E4440/polito/MAGISTRALE/current/tesi/SEfile_library/se3/L1.c"/>
  </compounddef>
</doxygen>
